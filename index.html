<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>iPod Timer Widget - 50% Scaled</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            width: 360px;      /* 300px × 1.2 → 360px */
            height: 180px;     /* 150px × 1.2 → 180px */
            overflow: hidden;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: transparent;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .ipod-container {
            width: 360px;      /* 300px × 1.2 → 360px */
            height: 180px;     /* 150px × 1.2 → 180px */
            position: relative;
            background-image: url('./아이팟 틀 이미지.png');
            background-size: contain;
            background-position: center;
            background-repeat: no-repeat;
        }

        .screen-area {
            position: absolute;
            width: 179.4px;    /* 149.5px × 1.2 → 179.4px */
            height: 134.4px;   /* 112px × 1.2 → 134.4px */
            left: 12.6px;      /* 10.5px × 1.2 → 12.6px */
            top: 22.2px;       /* 18.5px × 1.2 → 22.2px */
            border-radius: 4.8px; /* 4px × 1.2 → 4.8px */
            overflow: hidden;
        }

        .gradient-background {
            position: absolute;
            top: 4.2px;        /* 3.5px × 1.2 → 4.2px */
            left: 8.4px;       /* 7px × 1.2 → 8.4px */
            width: 96%;        /* unchanged - percentage */
            height: 94%;       /* unchanged - percentage */
            background-image: url('./검은색 그라데이션 배경.png');
            background-size: cover;
            background-position: center;
            z-index: 1;
            opacity: 0.9;      /* 90% opacity */
            filter: blur(3px); /* 3px 블러 효과 */
        }

        .screen-content {
            width: 100%;
            height: 100%;
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 2;
        }

        /* 초기 선택 화면 */
        .time-selector {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 100%;
            animation: fadeIn 0.3s ease; /* unchanged - animation time */
        }

        .time-navigation {
            display: flex;
            align-items: center;
            gap: 18px;         /* 15px × 1.2 → 18px */
        }

        .nav-arrow {
            color: #fff;       /* 흰색으로 복원 */
            font-size: 14.4px; /* 12px × 1.2 → 14.4px */
            cursor: pointer;
            transition: all 0.3s ease; /* unchanged - transition time */
            user-select: none;
            padding: 4.8px;    /* 4px × 1.2 → 4.8px */
        }

        .nav-arrow:hover {
            color: rgba(255, 255, 255, 0.9); /* 흰색으로 복원 */
            transform: scale(1.2); /* unchanged - scale ratio */
        }

        .time-display {
            color: rgba(255, 255, 255, 1); /* 흰색으로 복원 */
            font-size: 21.6px; /* 18px × 1.2 → 21.6px */
            font-weight: 900;  /* unchanged */
            cursor: pointer;
            transition: all 0.3s ease; /* unchanged - transition time */
            padding: 2.4px -10.8px; /* 2px × 1.2 → 2.4px, -9px × 1.2 → -10.8px */
            letter-spacing: 1.2px; /* 1px × 1.2 → 1.2px */
            min-width: 60px;   /* 50px × 1.2 → 60px */
            text-align: center;
        }

        .time-display:hover {
            color: rgba(255, 255, 255, 1); /* 흰색으로 복원 */
            transform: scale(1.1); /* unchanged - scale ratio */
            text-shadow: 0 0 12px rgba(255, 255, 255, 0.7); /* 0.6 → 0.7 (10% 밝기 증가) */
        }

        .time-display:active {
            transform: scale(0.95); /* unchanged - scale ratio */
        }

        /* 타이머 실행 화면 */
        .timer-display {
            display: none;
            width: 100%;
            height: 100%;
            padding: 12px;     /* 10px × 1.2 → 12px */
            flex-direction: column;
            animation: fadeIn 0.3s ease; /* unchanged - animation time */
        }

        .album-art-container {
            width: 89px;
            height: 86px;
            margin: 4.8px;
            border-radius: 6px;
            overflow: hidden;
            box-shadow: 0 1.2px 4.8px rgba(0, 0, 0, 0.4);
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
            background: linear-gradient(135deg, #444 0%, #222 100%);
        }

        .album-art-container:hover {
            transform: scale(1.03); /* unchanged - scale ratio */
            box-shadow: 0 1.8px 6px rgba(0,0,0,0.4); /* 1.5px × 1.2 → 1.8px, 5px × 1.2 → 6px */
        }

        .album-art {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }

        .default-art {
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #7788ff 0%, #8765b3 100%); /* #667eea→#7788ff, #764ba2→#8765b3 (10% 밝기 증가) */
            display: flex;
            align-items: center;
            justify-content: center;
            color: rgba(255,255,255,0.6); /* 0.5 → 0.6 (10% 밝기 증가) */
            font-size: 36px;   /* 30px × 1.2 → 36px */
        }

        .progress-container {
            position: absolute;
            bottom: 13.2px;    /* 11px × 1.2 → 13.2px */
            left: 23.4px;      /* 19.5px × 1.2 → 23.4px */
            right: 35.4px;     /* 29.5px × 1.2 → 35.4px */
            height: 6.76px;    /* 5.63px × 1.2 → 6.76px */
            background: #888888; /* #777777 → #888888 (10% 밝기 증가) */
            border-radius: 1.8px; /* 1.5px × 1.2 → 1.8px */
            overflow: hidden;
            opacity: 0.9;      /* unchanged - opacity */
        }

        .progress-bar {
            height: 100%;
            background: #fff;  /* unchanged - color */
            border-radius: 1.8px; /* 1.5px × 1.2 → 1.8px */
            transition: width 0.1s linear; /* unchanged - transition time */
            box-shadow: 0 0 3.6px rgba(255,255,255,0.5); /* 0.4 → 0.5 (10% 밝기 증가) */
            opacity: 0.9;      /* unchanged - opacity */
        }

        .time-remaining {
            position: absolute;
            bottom: 9.6px;     /* 8px × 1.2 → 9.6px */
            right: 3.6px;      /* 3px × 1.2 → 3.6px */
            color: #fff;       /* unchanged - color */
            font-size: 9.6px;  /* 8px × 1.2 → 9.6px */
            font-weight: 600;  /* unchanged */
            font-family: 'Courier New', monospace;
            letter-spacing: -0.3px; /* -0.25px × 1.2 → -0.3px */
            padding: 1.2px 2.4px; /* 1px × 1.2 → 1.2px, 2px × 1.2 → 2.4px */
        }

        /* 오버레이 버튼 영역 */
        .button-overlays {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }

        .center-button-overlay {
            position: absolute;
            right: 78px;       /* 65px × 1.2 → 78px */
            top: 50%;
            transform: translateY(-50%);
            width: 33px;       /* 27.5px × 1.2 → 33px */
            height: 33px;      /* 27.5px × 1.2 → 33px */
            cursor: pointer;
            pointer-events: auto;
            border-radius: 50%;
        }

        .pause-button-overlay {
            position: absolute;
            right: 84px;       /* 70px × 1.2 → 84px */
            bottom: 36px;      /* 30px × 1.2 → 36px */
            width: 21px;       /* 17.5px × 1.2 → 21px */
            height: 15px;      /* 12.5px × 1.2 → 15px */
            cursor: pointer;
            pointer-events: auto;
        }

        @keyframes fadeIn {
            from { opacity: 0; }  /* unchanged */
            to { opacity: 1; }    /* unchanged */
        }

        @keyframes blink {
            0%, 100% { opacity: 1; }  /* unchanged */
            50% { opacity: 0.3; }      /* unchanged */
        }

        .timer-complete .progress-bar {
            animation: blink 0.5s ease 3; /* unchanged - animation */
        }
    </style>
</head>
<body>
    <div class="ipod-container">
        <div class="screen-area">
            <div class="gradient-background"></div>
            <div class="screen-content">
                <!-- 시간 선택 화면 -->
                <div class="time-selector" id="timeSelector">
                    <div class="time-navigation">
                        <span class="nav-arrow" onclick="changeTime(-1)">◀</span>
                        <span class="time-display" id="timeDisplay" onclick="startSelectedTimer()">10M</span>
                        <span class="nav-arrow" onclick="changeTime(1)">▶</span>
                    </div>
                </div>

                <!-- 타이머 실행 화면 -->
                <div class="timer-display" id="timerDisplay">
                    <div class="album-art-container" id="albumContainer">
                        <div class="default-art" id="defaultArt">♪</div>
                        <img class="album-art" id="albumArt" style="display:none;" alt="Album Art">
                    </div>
                    <div class="progress-container">
                        <div class="progress-bar" id="progressBar"></div>
                    </div>
                    <div class="time-remaining" id="timeRemaining">00:00</div>
                </div>
            </div>
        </div>

        <!-- 오버레이 버튼 영역 -->
        <div class="button-overlays">
            <div class="center-button-overlay" onclick="resetTimer()"></div>
            <div class="pause-button-overlay" id="pauseBtn" onclick="togglePause()" style="display:none;"></div>
        </div>
    </div>

    <script>
        const timeOptions = [10, 20, 30];
        let currentTimeIndex = 0;
        let selectedTime = 0;
        let totalTime = 0;
        let remainingTime = 0;
        let isPaused = false;
        let timerInterval = null;
        let startTimestamp = null;
        let pausedTime = 0;

        // Color changing feature
        const colorImages = [
            './아이팟 틀 이미지.png',        // default
            './아이팟 틀 이미지_blue.png',   // blue
            './아이팟 틀 이미지_pink.png',   // pink
            './아이팟 틀 이미지_purple.png'  // purple
        ];
        
        const gradientImages = [
            './검은색 그라데이션 배경.png',    // default - black
            './파란색 그라데이션 배경.png',    // blue
            './분홍색 그라데이션 배경.png',    // pink
            './보라색 그라데이션 배경.png'     // purple
        ];
        
        let currentColorIndex = 0;

        // State persistence system
        const storage = {
            save: (key, value) => {
                try {
                    localStorage.setItem(key, JSON.stringify(value));
                } catch(e) {
                    try {
                        sessionStorage.setItem(key, JSON.stringify(value));
                    } catch(e2) {
                        console.log('Storage unavailable');
                    }
                }
            },
            load: (key) => {
                try {
                    return JSON.parse(localStorage.getItem(key) || sessionStorage.getItem(key));
                } catch(e) {
                    return null;
                }
            },
            remove: (key) => {
                try {
                    localStorage.removeItem(key);
                    sessionStorage.removeItem(key);
                } catch(e) {
                    console.log('Storage unavailable');
                }
            }
        };

        // Save current state
        const saveState = () => {
            storage.save('ipodTimer', {
                isRunning: !!timerInterval,
                selectedTime,
                remainingTime,
                isPaused,
                pausedTime,
                startTimestamp,
                currentColorIndex,
                currentTimeIndex,
                lastSaveTime: Date.now()
            });
        };

        // Clear saved state
        const clearState = () => {
            storage.remove('ipodTimer');
        };

        // Restore state from storage
        const restoreState = () => {
            const state = storage.load('ipodTimer');
            if (!state) return false;

            // Restore color first
            if (state.currentColorIndex !== undefined) {
                currentColorIndex = state.currentColorIndex;
                const container = document.querySelector('.ipod-container');
                const gradientBackground = document.querySelector('.gradient-background');
                container.style.backgroundImage = `url('${colorImages[currentColorIndex]}')`;
                gradientBackground.style.backgroundImage = `url('${gradientImages[currentColorIndex]}')`;
            }

            // Restore time selector
            if (state.currentTimeIndex !== undefined) {
                currentTimeIndex = state.currentTimeIndex;
                document.getElementById('timeDisplay').textContent = timeOptions[currentTimeIndex] + 'M';
            }

            // Restore timer if it was running
            if (state.isRunning && state.selectedTime) {
                selectedTime = state.selectedTime;
                totalTime = state.selectedTime * 60 * 1000;
                isPaused = state.isPaused || false;
                
                // Calculate current remaining time based on elapsed time since last save
                const now = Date.now();
                const timeSinceLastSave = now - (state.lastSaveTime || now);
                
                if (state.isPaused) {
                    // If was paused, use saved remaining time
                    remainingTime = state.remainingTime || totalTime;
                    pausedTime = state.pausedTime || 0;
                    startTimestamp = now; // Reset start time for when resumed
                } else {
                    // If was running, calculate new remaining time
                    const totalElapsed = (now - state.startTimestamp) - (state.pausedTime || 0);
                    remainingTime = Math.max(0, totalTime - totalElapsed);
                }

                // Only restore if there's time remaining
                if (remainingTime > 0) {
                    // Switch to timer display
                    document.getElementById('timeSelector').style.display = 'none';
                    document.getElementById('timerDisplay').style.display = 'flex';
                    document.getElementById('pauseBtn').style.display = 'block';

                    updateDisplay();

                    if (!isPaused) {
                        startTimestamp = now;
                        timerInterval = setInterval(updateTimer, 50);
                    }
                    
                    return true;
                } else {
                    // Timer would have completed, clear state and reset
                    clearState();
                    resetTimer();
                    return false;
                }
            }
            return false;
        };

        // 시간 변경 (화살표 클릭)
        function changeTime(direction) {
            currentTimeIndex += direction;
            if (currentTimeIndex < 0) currentTimeIndex = timeOptions.length - 1;
            if (currentTimeIndex >= timeOptions.length) currentTimeIndex = 0;
            
            document.getElementById('timeDisplay').textContent = timeOptions[currentTimeIndex] + 'M';
            saveState(); // Save state when time selection changes
        }

        // 선택된 시간으로 타이머 시작
        function startSelectedTimer() {
            startTimer(timeOptions[currentTimeIndex]);
        }

        // URL 파라미터에서 이미지 가져오기
        function loadImageFromURL() {
            const params = new URLSearchParams(window.location.search);
            const imageUrl = params.get('image');
            
            if (imageUrl) {
                const img = document.getElementById('albumArt');
                const defaultArt = document.getElementById('defaultArt');
                
                console.log('Loading image:', imageUrl);
                
                img.onload = function() {
                    console.log('Image loaded successfully');
                    img.style.display = 'block';
                    defaultArt.style.display = 'none';
                };
                
                img.onerror = function(e) {
                    console.error('Image failed to load:', e);
                    console.log('Trying CORS proxy...');
                    
                    // CORS 프록시를 사용하여 재시도
                    const proxyUrl = 'https://cors-anywhere.herokuapp.com/' + decodeURIComponent(imageUrl);
                    img.src = proxyUrl;
                    
                    img.onerror = function() {
                        console.log('CORS proxy also failed, falling back to default art');
                        img.style.display = 'none';
                        defaultArt.style.display = 'flex';
                    };
                };
                
                // 먼저 직접 로드 시도
                img.crossOrigin = 'anonymous';
                img.src = decodeURIComponent(imageUrl);
            }
        }

        // 타이머 시작
        function startTimer(minutes) {
            selectedTime = minutes;
            totalTime = minutes * 60 * 1000;
            remainingTime = totalTime;
            isPaused = false;
            startTimestamp = Date.now();
            pausedTime = 0;

            // 화면 전환
            document.getElementById('timeSelector').style.display = 'none';
            document.getElementById('timerDisplay').style.display = 'flex';
            document.getElementById('pauseBtn').style.display = 'block';

            // 초기 상태 설정
            updateDisplay();
            
            // 타이머 실행
            timerInterval = setInterval(updateTimer, 50);
            
            saveState(); // Save state when timer starts
        }

        // 타이머 업데이트
        function updateTimer() {
            if (!isPaused) {
                const currentTime = Date.now();
                const elapsed = currentTime - startTimestamp - pausedTime;
                remainingTime = Math.max(0, totalTime - elapsed);
                
                updateDisplay();
                
                if (remainingTime <= 0) {
                    onTimerComplete();
                }
            }
        }

        // 화면 업데이트
        function updateDisplay() {
            const percentage = (remainingTime / totalTime) * 100;
            document.getElementById('progressBar').style.width = percentage + '%';
            
            const minutes = Math.floor(remainingTime / 60000);
            const seconds = Math.floor((remainingTime % 60000) / 1000);
            const display = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
            document.getElementById('timeRemaining').textContent = display;
        }

        // 일시정지/재개
        function togglePause() {
            if (remainingTime <= 0) return;
            
            isPaused = !isPaused;
            
            if (isPaused) {
                pausedTime += Date.now() - startTimestamp;
            } else {
                startTimestamp = Date.now();
            }
            
            saveState(); // Save state when pause/resume occurs
        }

        // 타이머 완료
        function onTimerComplete() {
            clearInterval(timerInterval);
            document.querySelector('.screen-content').classList.add('timer-complete');
            
            clearState(); // Clear saved state when timer completes naturally
            
            setTimeout(() => {
                resetTimer();
            }, 3000);
        }

        // 타이머 리셋 (MUSIC 버튼)
        function resetTimer() {
            clearInterval(timerInterval);
            document.querySelector('.screen-content').classList.remove('timer-complete');
            document.getElementById('timeSelector').style.display = 'flex';
            document.getElementById('timerDisplay').style.display = 'none';
            document.getElementById('pauseBtn').style.display = 'none';
            
            selectedTime = 0;
            totalTime = 0;
            remainingTime = 0;
            isPaused = false;
            pausedTime = 0;
            
            clearState(); // Clear saved state when user manually resets
        }

        // Color cycling function
        function cycleColor(event) {
            // Check if click is on screen area, wheel buttons, or overlays - if so, ignore
            if (event.target.closest('.screen-area') || 
                event.target.closest('.button-overlays') ||
                event.target.closest('.center-button-overlay') ||
                event.target.closest('.pause-button-overlay')) {
                return;
            }

            currentColorIndex = (currentColorIndex + 1) % colorImages.length;
            
            // Update iPod container color
            const container = document.querySelector('.ipod-container');
            container.style.backgroundImage = `url('${colorImages[currentColorIndex]}')`;
            
            // Update gradient background to match
            const gradientBackground = document.querySelector('.gradient-background');
            gradientBackground.style.backgroundImage = `url('${gradientImages[currentColorIndex]}')`;
            
            saveState(); // Save state when color changes
        }

        // Add visibility change listener for state persistence
        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                saveState(); // Save state when page becomes hidden
            }
        });

        // Add beforeunload listener for state persistence
        window.addEventListener('beforeunload', saveState);

        // 페이지 로드 시 이미지 로드
        window.onload = function() {
            loadImageFromURL();
            
            // Try to restore previous state first
            const stateRestored = restoreState();
            
            // Add color cycling click listener to container
            const container = document.querySelector('.ipod-container');
            container.addEventListener('click', cycleColor);
            container.style.cursor = 'pointer';
        };
    </script>
</body>
</html>
